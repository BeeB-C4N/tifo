<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIFO - 観光猫型AIアドバイザリー</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tifo-bg: #F7FAFC;
            --tifo-text: #2D3748;
            --tifo-primary: #4FD1C5;
            --tifo-primary-dark: #38B2AC;
            --tifo-card-border: #E2E8F0;
            --tifo-card-bg: #FFFFFF;
            /* 県のカラーコード */
            --color-toyama-bg: #4db56a;
            --color-ishikawa-bg: #008cbe;
            --color-fukui-bg: #00006b;
            --color-pref-text: #ffffff;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--tifo-bg);
            color: var(--tifo-text);
        }
        .tifo-card {
            background-color: var(--tifo-card-bg);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--tifo-card-border);
        }
        .tifo-button {
            background-color: var(--tifo-primary);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            border-bottom: 4px solid var(--tifo-primary-dark);
            transition: all 0.2s ease;
        }
        .tifo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -3px rgba(79, 209, 197, 0.4);
        }
        .tifo-button:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        .prefecture-btn {
            background-color: var(--tifo-card-bg);
            color: var(--tifo-primary-dark);
            font-weight: bold;
            padding: 0.5rem 1.25rem;
            border-radius: 9999px;
            border: 2px solid var(--tifo-card-border);
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
        }
        .prefecture-btn:hover {
            transform: translateY(-2px);
            border-color: var(--tifo-primary);
            box-shadow: 0 6px 12px -3px rgba(79, 209, 197, 0.3);
        }
        .tab-button {
            padding: 0.75rem 1rem;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #A0AEC0;
            transition: all 0.2s ease;
        }
        .tab-button:hover {
            background-color: #F7FAFC;
            color: #4A5568;
        }
        .tab-button.active {
            color: var(--tifo-primary);
            border-bottom-color: var(--tifo-primary);
        }
        .rank-badge {
            width: 2.25rem; height: 2.25rem; border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center; font-weight: bold; color: white;
            flex-shrink: 0; font-size: 1rem;
        }
        .rank-1 { background-color: #FFD700; }
        .rank-2 { background-color: #C0C0C0; }
        .rank-3 { background-color: #CD7F32; }
        .rank-default { background-color: #A9A9A9; }
        
        .pref-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 9999px;
        }
        .pref-toyama { background-color: var(--color-toyama-bg); color: var(--color-pref-text); }
        .pref-ishikawa { background-color: var(--color-ishikawa-bg); color: var(--color-pref-text); }
        .pref-fukui { background-color: var(--color-fukui-bg); color: var(--color-pref-text); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
    </style>
</head>
<body class="text-gray-800">
    
    <div id="loading-indicator" class="min-h-screen flex flex-col items-center justify-center p-4 text-center">
        <p class="text-gray-600">データを読み込んでいます...</p>
    </div>

    <div id="app-container" class="container mx-auto p-4 md:p-8 max-w-4xl hidden">

        <!-- ヘッダー: ロゴとキャラクター -->
        <header class="flex items-center justify-center gap-4 mb-4 text-center">
            <div class="w-24 h-24">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <path fill="var(--tifo-primary)" d="M47.9,-51.9C62.4,-41.2,74.7,-25.9,78.2,-8.1C81.7,9.7,76.4,30.1,64.8,44.2C53.2,58.3,35.3,66.1,17.7,70.8C0.1,75.5,-17.2,77.1,-33.1,70.2C-49,63.3,-63.5,47.9,-71.4,30.1C-79.3,12.3,-80.6,-7.8,-74.3,-24.1C-68,-40.4,-54.1,-52.9,-38.8,-60.1C-23.5,-67.3,-6.8,-69.2,8.9,-66.1C24.6,-63,47.9,-51.9,47.9,-51.9Z" transform="translate(100 100)"></path>
                    <text x="50%" y="55%" text-anchor="middle" dominant-baseline="middle" font-size="50" font-weight="bold" fill="white" letter-spacing="2">TIFO</text>
                </svg>
            </div>
            <img src="tifo.png" alt="TIFOちゃん" class="h-20 w-20 object-contain">
        </header>
        <p class="text-lg text-gray-600 mb-8 text-center">観光猫型AIアドバイザリー</p>

        <!-- 県選択ボタン -->
        <section class="mb-8">
            <div class="flex items-center justify-center gap-4">
                <button class="prefecture-btn">富山</button>
                <a href="https://beeb-c4n.github.io/tifo/ishikawa/#" class="prefecture-btn" target="_blank" rel="noopener noreferrer">石川</a>
                <button class="prefecture-btn">福井</button>
            </div>
        </section>

        <!-- 分析ボタン -->
        <section class="text-center mb-8">
            <button id="analysis-btn" class="tifo-button text-lg px-8">
                ３県連携データ分析
            </button>
        </section>

        <!-- 分析結果表示エリア -->
        <main id="analysis-results" class="hidden space-y-8">
            <section class="tifo-card">
                <div class="flex border-b border-gray-200 mb-4">
                    <button id="nps-tab" class="tab-button active">NPS</button>
                    <button id="satisfaction-tab" class="tab-button">施設全体満足度</button>
                </div>
                <div id="ranking-container" class="custom-scrollbar h-96 overflow-y-auto pr-2 space-y-3"></div>
            </section>
            <section class="tifo-card">
                <h2 class="text-xl font-bold mb-4 border-b border-gray-200 pb-3" style="color: var(--tifo-primary-dark);">セグメント別ランキング</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <select id="category-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400">
                        <option selected value="">分析軸を選択...</option>
                        <option value="age">年代</option>
                        <option value="gender">性別</option>
                        <option value="stay">宿泊数</option>
                        <option value="companion">同伴者</option>
                        <option value="purpose">旅の目的</option>
                        <option value="prefecture">都道府県</option>
                    </select>
                    <select id="detail-filter" class="w-full p-2.5 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400" disabled>
                        <option selected value="">詳細を選択...</option>
                    </select>
                </div>
                <div id="segment-ranking-container" class="custom-scrollbar h-96 overflow-y-auto pr-2 space-y-3">
                     <p class="text-gray-500 text-center pt-10">はじめに分析軸を選択してください。</p>
                </div>
            </section>
        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

    let surveyData = [];
    const loadingIndicator = document.getElementById('loading-indicator');
    const appContainer = document.getElementById('app-container');

    const filterOptions = {
        age: ['10代','20代','30代','40代','50代','60代','70代','80代','90代','100代'],
        gender: ['男性', '女性'],
        stay: ['1泊', '2泊', '3泊', '4泊以上', '日帰り'],
        companion: ['自分ひとり','恋人','友人','夫婦2人','団体旅行','親戚','親','職場の同僚','小学生以下連れの家族','中学生以下連れの家族','高校生連れの家族','災害支援'],
        purpose: ['宿でのんびり過ごす','温泉や露天風呂','地元の美味しいものを食べる','花見や紅葉などの自然鑑賞','名所、旧跡の観光','テーマパーク（遊園地、動物園、博物館など）','買い物、アウトレット','お祭りやイベントへの参加・見物','スポーツ観戦や芸能鑑賞（コンサート等）','アウトドア（海水浴、釣り、登山など）','まちあるき、都市散策','各種体験（手作り、果物狩りなど）','スキー・スノボ、マリンスポーツ','その他スポーツ（ゴルフ、テニスなど）','ドライブ・ツーリング','友人・親戚を尋ねる','出張など仕事関係'],
        prefecture: ['北海道','青森県','岩手県','宮城県','秋田県','山形県','福島県','茨城県','栃木県','群馬県','埼玉県','千葉県','東京都','神奈川県','新潟県','富山県','石川県','福井県','山梨県','長野県','岐阜県','静岡県','愛知県','三重県','滋賀県','京都府','大阪府','兵庫県','奈良県','和歌山県','鳥取県','島根県','岡山県','広島県','山口県','徳島県','香川県','愛媛県','高知県','福岡県','佐賀県','長崎県','熊本県','大分県','宮崎県','鹿児島県','沖縄県']
    };
    
    // --- CSVをパースしてオブジェクトの配列に変換する関数 (修正版) ---
    const parseCSV = (csvText) => {
        // Excelなどで保存した際のBOM(Byte Order Mark)を除去
        if (csvText.charCodeAt(0) === 0xFEFF) {
            csvText = csvText.slice(1);
        }
        const lines = csvText.trim().replace(/\r/g, '').split('\n');
        if (lines.length < 2) return [];

        // 正規表現でカンマ区切り、かつ""で囲まれた値に対応
        const csvRegex = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^,]*))/g;
        
        const parseLine = (line) => {
            const values = [];
            let match;
            csvRegex.lastIndex = 0;
            while (match = csvRegex.exec(line)) {
                let value = match[1] ? match[1].replace(/""/g, '"') : match[2];
                values.push(value);
            }
            return values;
        };

        const headers = parseLine(lines[0]);
        
        return lines.slice(1).map(line => {
            if (!line.trim()) return null; // 空行をスキップ
            const values = parseLine(line);
            const entry = {};
            headers.forEach((header, index) => {
                const key = header.trim();
                const rawValue = (values[index] || '').trim();
                
                if (rawValue === '') {
                    entry[key] = null; // 空欄は null とする
                } else {
                    const numValue = parseFloat(rawValue);
                    entry[key] = !isNaN(numValue) ? numValue : rawValue;
                }
            });
            // TIFカラムを「県」にリネーム
            if (entry['TIF']) {
                entry['県'] = entry['TIF'];
                delete entry['TIF'];
            }
            return entry;
        }).filter(Boolean); // nullになった空行を除外
    };


    // --- メインの初期化処理 ---
    const initializeApp = async () => {
        try {
            const response = await fetch('./tif_score.csv');
            if (!response.ok) {
                throw new Error(`CSVファイルの読み込みに失敗しました: ${response.statusText}`);
            }
            const csvText = await response.text();
            const allData = parseCSV(csvText);
            
            // 回答数が30以上の施設のみをフィルタリング
            surveyData = allData.filter(item => item['全回答数'] >= 30);

            if (surveyData.length === 0) {
                 throw new Error('表示対象となるデータ（回答数30件以上）がありません。');
            }
            
            loadingIndicator.classList.add('hidden');
            appContainer.classList.remove('hidden');
            setupEventListeners();
        } catch (error) {
            loadingIndicator.innerHTML = `<p class="text-red-500 font-bold">エラーが発生しました。</p><p class="text-sm mt-2">${error.message}</p>`;
            console.error(error);
        }
    };
    
    // --- イベントリスナーをセットアップする関数 ---
    const setupEventListeners = () => {
        const analysisBtn = document.getElementById('analysis-btn');
        const analysisResults = document.getElementById('analysis-results');
        const npsTab = document.getElementById('nps-tab');
        const satisfactionTab = document.getElementById('satisfaction-tab');
        const categoryFilter = document.getElementById('category-filter');
        const detailFilter = document.getElementById('detail-filter');
        let currentTab = 'nps';

        analysisBtn.addEventListener('click', () => {
            analysisResults.classList.toggle('hidden');
            if (!analysisResults.classList.contains('hidden')) {
                renderSimpleRanking(currentTab);
            }
        });

        npsTab.addEventListener('click', () => {
            if (currentTab !== 'nps') {
                currentTab = 'nps';
                npsTab.classList.add('active');
                satisfactionTab.classList.remove('active');
                renderSimpleRanking('nps');
            }
        });

        satisfactionTab.addEventListener('click', () => {
            if (currentTab !== 'satisfaction') {
                currentTab = 'satisfaction';
                satisfactionTab.classList.add('active');
                npsTab.classList.remove('active');
                renderSimpleRanking('satisfaction');
            }
        });
        
        categoryFilter.addEventListener('change', () => {
            const selectedCategory = categoryFilter.value;
            detailFilter.innerHTML = '<option selected value="">詳細を選択...</option>';
            document.getElementById('segment-ranking-container').innerHTML = '<p class="text-gray-500 text-center pt-10">詳細を選択してください。</p>';

            if (selectedCategory) {
                filterOptions[selectedCategory].forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    detailFilter.appendChild(optionElement);
                });
                detailFilter.disabled = false;
            } else {
                detailFilter.disabled = true;
                 document.getElementById('segment-ranking-container').innerHTML = '<p class="text-gray-500 text-center pt-10">はじめに分析軸を選択してください。</p>';
            }
        });
        
        detailFilter.addEventListener('change', renderSegmentRanking);
    };

    // --- ランキング描画関数 ---
    const createRankingCard = (rank, name, score, prefecture, unit = '') => {
        let rankClass = 'rank-default';
        if (rank === 1) rankClass = 'rank-1';
        if (rank === 2) rankClass = 'rank-2';
        if (rank === 3) rankClass = 'rank-3';

        const prefectureClasses = {
            "富山": "pref-toyama",
            "石川": "pref-ishikawa",
            "福井": "pref-fukui",
        };
        const prefClass = prefectureClasses[prefecture] || 'bg-gray-200 text-gray-800';
        const prefBadge = `<span class="pref-badge ${prefClass}">${prefecture}</span>`;
        
        const scoreDisplay = (typeof score === 'number') ? score.toFixed(1) : 'N/A';

        return `
            <div class="flex items-center bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                <div class="rank-badge ${rankClass}">${rank}</div>
                <div class="flex-grow ml-4">
                    <p class="font-semibold text-gray-700">${name}</p>
                    <div class="mt-1">${prefBadge}</div>
                </div>
                <div class="text-right">
                    <p class="text-2xl font-bold" style="color: var(--tifo-primary-dark);">${scoreDisplay}<span class="text-sm text-gray-500 ml-1">${unit}</span></p>
                </div>
            </div>
        `;
    };

    const renderSimpleRanking = (type) => {
        const rankingContainer = document.getElementById('ranking-container');
        const sortKey = type === 'nps' ? 'NPS' : '施設全体満足度';

        const sortedData = [...surveyData].sort((a, b) => {
            const valA = (typeof a[sortKey] === 'number') ? a[sortKey] : -Infinity;
            const valB = (typeof b[sortKey] === 'number') ? b[sortKey] : -Infinity;
            return valB - valA;
        });
        
        rankingContainer.innerHTML = sortedData
            .map((item, index) => {
                const scoreValue = item[sortKey];
                let score;
                if (typeof scoreValue !== 'number') {
                    score = 'N/A'; // データがない場合は'N/A'
                } else {
                    score = type === 'nps' ? scoreValue * 100 : scoreValue;
                }
                
                return createRankingCard(index + 1, item['施設'], score, item['県'], type === 'satisfaction' ? '点' : '');
            })
            .join('');
    };

    const renderSegmentRanking = () => {
        const segmentRankingContainer = document.getElementById('segment-ranking-container');
        const filterValue = document.getElementById('detail-filter').value;

        if (!filterValue) {
            segmentRankingContainer.innerHTML = '<p class="text-gray-500 text-center pt-10">詳細を選択してください。</p>';
            return;
        }

        const calculatedData = surveyData.map(item => {
            const segmentCount = item[filterValue];
            const totalCount = item['全回答数'];
            // 割合を計算。データがない場合は-1としてソートで最後尾に
            const percentage = (typeof segmentCount === 'number' && totalCount > 0) ? (segmentCount / totalCount) * 100 : -1;
            return { ...item, percentage: percentage };
        }).sort((a, b) => b.percentage - a.percentage);

        segmentRankingContainer.innerHTML = calculatedData
            .map((item, index) => createRankingCard(index + 1, item['施設'], item.percentage, item['県'], '%'))
            .join('');
    };

    // --- アプリケーションの実行 ---
    initializeApp();
});
</script>

</body>
</html>

