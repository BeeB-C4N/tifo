<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIFO - è¦³å…‰çŒ«å‹ã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tifo-bg: #F7FAFC;
            --tifo-text: #2D3748;
            --tifo-primary: #4FD1C5;
            --tifo-primary-dark: #38B2AC;
            --tifo-card-border: #E2E8F0;
            --tifo-card-bg: #FFFFFF;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--tifo-bg);
            color: var(--tifo-text);
        }
        .tifo-card {
            background-color: var(--tifo-card-bg);
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--tifo-card-border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .tifo-button {
            background-color: var(--tifo-primary);
            color: white;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            border-bottom: 4px solid var(--tifo-primary-dark);
            transition: all 0.2s ease;
        }
        .tifo-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px -3px rgba(79, 209, 197, 0.4);
        }
        .tifo-button:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
        }
        .rank-badge {
            width: 2rem; height: 2rem; border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center; font-weight: bold; color: white;
            flex-shrink: 0;
        }
        .rank-1 { background-color: #FFD700; }
        .rank-2 { background-color: #C0C0C0; }
        .rank-3 { background-color: #CD7F32; }
        .rank-4, .rank-5 { background-color: #A9A9A9; }
        .progress-bar-bg { background-color: #EDF2F7; border-radius: 9999px; overflow: hidden; height: 1.25rem; }
        .progress-bar {
            background-color: var(--tifo-primary);
            height: 100%;
            border-radius: 9999px;
            transition: width 0.5s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .nps-bar-container { position: relative; background: linear-gradient(to right, #FEB2B2, #EDF2F7, #9AE6B4); height: 0.75rem; border-radius: 9999px; }
        .nps-bar-marker { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 1.25rem; background-color: rgba(113, 128, 150, 0.5); border-radius: 1px; }
        .nps-bar-value { position: absolute; top: 50%; transform: translateY(-50%); width: 0.75rem; height: 0.75rem; background-color: var(--tifo-text); border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.3); transition: left 0.5s ease-in-out; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 600px; max-height: 80vh; overflow-y: auto; }
    </style>
</head>
<body>
    <!-- ãƒ›ãƒ¼ãƒ ç”»é¢ -->
    <div id="home-screen" class="min-h-screen flex flex-col items-center justify-center p-4 text-center">
        <div class="flex items-center justify-center gap-4 mb-4">
            <div class="w-24 h-24">
                <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                    <path fill="var(--tifo-primary)" d="M47.9,-51.9C62.4,-41.2,74.7,-25.9,78.2,-8.1C81.7,9.7,76.4,30.1,64.8,44.2C53.2,58.3,35.3,66.1,17.7,70.8C0.1,75.5,-17.2,77.1,-33.1,70.2C-49,63.3,-63.5,47.9,-71.4,30.1C-79.3,12.3,-80.6,-7.8,-74.3,-24.1C-68,-40.4,-54.1,-52.9,-38.8,-60.1C-23.5,-67.3,-6.8,-69.2,8.9,-66.1C24.6,-63,47.9,-51.9,47.9,-51.9Z" transform="translate(100 100)" />
                    <text x="50%" y="55%" text-anchor="middle" dominant-baseline="middle" font-size="50" font-weight="bold" fill="white" letter-spacing="2">TIFO</text>
                </svg>
            </div>
            <img src="tifo.png" alt="TIFOã¡ã‚ƒã‚“" class="h-20 w-20 object-contain">
        </div>
        <p class="text-lg text-gray-600 mb-8">è¦³å…‰AIã‚¢ãƒ‰ãƒã‚¤ã‚¶ãƒªãƒ¼</p>
        <div id="loading-message" class="text-gray-600"><p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p></div>
        <div id="main-content" class="w-full max-w-md hidden">
            <label for="facility-select" class="block mb-2 text-gray-700 font-bold">åˆ†æã—ãŸã„æ–½è¨­ã‚’é¸ã‚“ã§ã«ã‚ƒğŸ¾</label>
            <select id="facility-select" class="w-full p-3 border border-gray-300 rounded-xl shadow-sm focus:ring-2 focus:ring-teal-400 focus:border-teal-400"></select>
            <button id="analyze-button" class="tifo-button w-full mt-6">ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æ</button>
        </div>
        <div class="absolute bottom-4">
            <button id="disclaimer-button" class="text-sm text-gray-500 hover:underline">å…è²¬äº‹é …</button>
        </div>
    </div>

    <!-- åˆ†æçµæœç”»é¢ -->
    <div id="analysis-screen" class="hidden p-4 md:p-8 max-w-5xl mx-auto">
        <header class="flex items-center justify-between mb-8">
            <h1 id="facility-title" class="text-3xl font-bold"></h1>
            <button id="back-button" class="tifo-button">æˆ»ã‚‹</button>
        </header>

        <main class="space-y-8">
            <section>
                <h2 class="text-2xl font-bold mb-4 flex items-center">åŸºæœ¬ã‚¹ã‚³ã‚¢</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="tifo-card text-center"><h3 class="text-lg font-bold mb-2">å…¨å›ç­”æ•°</h3><p id="total-answers" class="text-6xl font-bold" style="color: var(--tifo-primary);"></p><div id="answer-trend" class="text-sm mt-2 flex items-center justify-center"></div><p id="total-answers-rank" class="text-sm text-gray-500 mt-3"></p></div>
                    <div class="tifo-card text-center"><h3 class="text-lg font-bold mb-2">â¤ï¸ NPS (é¡§å®¢æ¨å¥¨åº¦)</h3><p id="nps-score" class="text-6xl font-bold" style="color: var(--tifo-primary);"></p><p class="text-xs text-gray-500">(-100 ~ 100ã®ç¯„å›²)</p><div class="w-full mt-3 relative"><div class="nps-bar-container"><div class="nps-bar-marker"></div><div id="nps-bar-value" class="nps-bar-value"></div></div></div><p id="nps-rank" class="text-sm text-gray-500 mt-3"></p></div>
                </div>
                <h2 class="text-2xl font-bold mb-4 flex items-center">å„ç¨®æº€è¶³åº¦ã‚¹ã‚³ã‚¢</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="tifo-card text-center"><h3 class="text-lg font-bold mb-2">ğŸ å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹</h3><div class="flex items-baseline justify-center"><p id="product-satisfaction" class="text-5xl font-bold" style="color: var(--tifo-primary);"></p><span class="text-2xl font-bold text-gray-500">/ 5.0</span></div><div class="w-full progress-bar-bg mt-3"><div id="product-satisfaction-bar" class="progress-bar" style="height: 1rem;"></div></div><p id="product-satisfaction-rank" class="text-sm text-gray-500 mt-3"></p></div>
                    <div class="tifo-card text-center"><h3 class="text-lg font-bold mb-2">ğŸ¨ æ–½è¨­å…¨ä½“</h3><div class="flex items-baseline justify-center"><p id="facility-satisfaction" class="text-5xl font-bold" style="color: var(--tifo-primary);"></p><span class="text-2xl font-bold text-gray-500">/ 5.0</span></div><div class="w-full progress-bar-bg mt-3"><div id="facility-satisfaction-bar" class="progress-bar" style="height: 1rem;"></div></div><p id="facility-satisfaction-rank" class="text-sm text-gray-500 mt-3"></p></div>
                    <div class="tifo-card text-center"><h3 class="text-lg font-bold mb-2">ğŸš— æ—…å…¨ä½“</h3><div class="flex items-baseline justify-center"><p id="trip-satisfaction" class="text-5xl font-bold" style="color: var(--tifo-primary);"></p><span class="text-2xl font-bold text-gray-500">/ 5.0</span></div><div class="w-full progress-bar-bg mt-3"><div id="trip-satisfaction-bar" class="progress-bar" style="height: 1rem;"></div></div><p id="trip-satisfaction-rank" class="text-sm text-gray-500 mt-3"></p></div>
                </div>
            </section>
            
            <section id="persona-section" class="tifo-card hidden">
                <h2 class="text-2xl font-bold mb-2 flex items-center gap-3">
                    ãƒšãƒ«ã‚½ãƒŠåˆ†æ
                </h2>
                <p class="text-gray-600 mb-6">
                    ã‚ãªãŸã®æ–½è¨­ã«æœ€ã‚‚å›ç­”ã—ã¦ã„ã‚‹é¡§å®¢ã‚°ãƒ«ãƒ¼ãƒ—TOP3ã§ã™ã€‚
                </p>
                <div id="persona-container" class="space-y-6">
                </div>
                <template id="persona-template">
                    <div class="border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center gap-4 mb-3">
                            <span class="rank-badge"></span>
                            <h3 class="text-xl font-bold text-gray-800"></h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                            <div class="persona-details space-y-2 text-gray-700">
                                <p class="flex items-center gap-3"><span class="persona-companion-icon text-2xl w-8 text-center"></span> <span class="font-bold">åŒä¼´è€…:</span> <span class="persona-companion"></span></p>
                                <p class="flex items-center gap-3"><span class="persona-age-icon text-2xl w-8 text-center"></span> <span class="font-bold">å¹´ã€€ä»£:</span> <span class="persona-age"></span></p>
                                <p class="flex items-center gap-3"><span class="text-2xl w-8 text-center">ğŸ—¾</span> <span class="font-bold">åœ°ã€€æ–¹:</span> <span class="persona-region"></span></p>
                                <p class="flex items-center gap-3"><span class="text-2xl w-8 text-center">ğŸ’°</span> <span class="font-bold">å¹´ã€€å:</span> <span class="persona-income"></span></p>
                            </div>
                            <div class="space-y-2">
                                <label class="font-bold text-gray-700">å›ç­”è€…å…¨ä½“ã«ãŠã‘ã‚‹å‰²åˆï¼ˆç¢ºåº¦ï¼‰</label>
                                <div class="progress-bar-bg">
                                    <div class="progress-bar" style="width: 0%;"></div>
                                </div>
                                <p class="persona-counts text-right text-sm text-gray-500"></p>
                            </div>
                        </div>
                    </div>
                </template>
            </section>

            <section>
                <h2 class="text-2xl font-bold mb-4 flex items-center">ã‚°ãƒ«ãƒ¼ãƒ—åˆ¥ æ¥è¨ªè€…TOP5</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="tifo-card"><h3 class="text-lg font-bold mb-4">ğŸš» æ€§åˆ¥</h3><ul id="gender-ranking" class="space-y-3"></ul></div>
                    <div class="tifo-card"><h3 class="text-lg font-bold mb-4">ğŸ‚ å¹´ä»£</h3><ul id="age-ranking" class="space-y-3"></ul></div>
                    <div class="tifo-card"><h3 class="text-lg font-bold mb-4">ğŸŒ™ å®¿æ³Šæ—¥æ•°</h3><ul id="stay-duration-ranking" class="space-y-3"></ul></div>
                    <div class="tifo-card"><h3 class="text-lg font-bold mb-4">ğŸ‘ª åŒä¼´è€…</h3><ul id="companion-ranking" class="space-y-3"></ul></div>
                    <div class="tifo-card col-span-1 md:col-span-2"><h3 class="text-lg font-bold mb-4">âœˆï¸ æ—…ã®ç›®çš„</h3><ul id="purpose-ranking" class="space-y-3"></ul></div>
                    <div class="tifo-card col-span-1 md:col-span-2"><h3 class="text-lg font-bold mb-4">ğŸ’° ä¸–å¸¯å¹´å</h3><ul id="income-ranking" class="space-y-3"></ul></div>
                    <div class="tifo-card col-span-1 md:col-span-2"><h3 class="text-lg font-bold mb-4">ğŸ—¾ éƒ½é“åºœçœŒ</h3><ul id="prefecture-ranking" class="space-y-3"></ul></div>
                </div>
            </section>
            
            <section>
                 <h2 class="text-2xl font-bold mb-4 flex items-center">Tifoã¡ã‚ƒã‚“ã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
                 <div class="flex items-start gap-4">
                     <img src="tifo.png" alt="TIFOã¡ã‚ƒã‚“" class="h-32 w-32 object-contain flex-shrink-0">
                     <div class="bg-white p-4 rounded-r-xl rounded-bl-xl relative w-full">
                         <div class="absolute left-[-10px] top-[15px] w-0 h-0 border-t-[10px] border-t-transparent border-r-[10px] border-r-white border-b-[10px] border-b-transparent"></div>
                         <p id="tifo-advice-text" class="text-gray-700"></p>
                     </div>
                 </div>
            </section>
        </main>
    </div>

    <!-- å…è²¬äº‹é …ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="disclaimer-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">å…è²¬äº‹é …</h2>
            <div id="disclaimer-text" class="text-sm text-gray-600 leading-relaxed space-y-2"></div>
            <button id="close-modal-button" class="tifo-button mt-6 w-full">é–‰ã˜ã‚‹</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    let surveyData = [];
    let personaData = [];
    let scoreFacilityKey = '';
    let personaFacilityKey = '';
    let adviceLines = [];

    const homeScreen = document.getElementById('home-screen');
    const analysisScreen = document.getElementById('analysis-screen');
    const facilitySelect = document.getElementById('facility-select');
    const analyzeButton = document.getElementById('analyze-button');
    const backButton = document.getElementById('back-button');
    const loadingMessage = document.getElementById('loading-message');
    const mainContent = document.getElementById('main-content');
    const disclaimerButton = document.getElementById('disclaimer-button');
    const disclaimerModal = document.getElementById('disclaimer-modal');
    const closeModalButton = document.getElementById('close-modal-button');
    
    function parseCSV(text) {
        if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
        
        const lines = text.trim().split(/\r?\n/);
        const regex = /(?:^|,)(?:"([^"]*(?:""[^"]*)*)"|([^,]*))/g;
        
        const headers = [];
        let match;
        while(match = regex.exec(lines[0])) {
            let value = match[1] !== undefined ? match[1].replace(/""/g, '"') : match[2];
            headers.push(value.trim());
        }

        const facilityKey = headers[0];
        if (!facilityKey) throw new Error("CSV file has no headers.");

        const data = lines.slice(1).map(line => {
            const obj = {};
            let i = 0;
            regex.lastIndex = 0;
            while(match = regex.exec(line)) {
                if(i < headers.length) {
                    const header = headers[i];
                    let value = match[1] !== undefined ? match[1].replace(/""/g, '"') : match[2];
                    
                    if (value === null || value.trim() === '') {
                        obj[header] = null;
                    } else {
                        const numValue = Number(value);
                        obj[header] = !isNaN(numValue) && value.trim() !== '' ? numValue : value;
                    }
                    i++;
                }
            }
            return obj;
        });
        
        return { data, key: facilityKey };
    }

    const handleRouteChange = () => {
        const hash = location.hash.substring(1);
        const facilityNameFromHash = decodeURIComponent(hash);
        if (facilityNameFromHash && surveyData.length > 0) {
            const facilityData = surveyData.find(d => d[scoreFacilityKey] === facilityNameFromHash);
            if (facilityData) {
                displayAnalysis(facilityData);
                homeScreen.classList.add('hidden');
                analysisScreen.classList.remove('hidden');
                facilitySelect.value = facilityNameFromHash;
                return;
            }
        }
        homeScreen.classList.remove('hidden');
        analysisScreen.classList.add('hidden');
    };

    async function loadData() {
        try {
            const [scoreResponse, personaResponse, adviceResponse] = await Promise.all([
                fetch('./milli_score.csv'),
                fetch('./milli_persona.csv'),
                fetch('./tifo_advice.txt').catch(e => null)
            ]);

            if (!scoreResponse.ok) throw new Error(`milli_score.csv failed to load: ${scoreResponse.statusText}`);
            if (!personaResponse.ok) throw new Error(`milli_persona.csv failed to load: ${personaResponse.statusText}`);
            
            const scoreText = await scoreResponse.text();
            const scoreResult = parseCSV(scoreText);
            surveyData = scoreResult.data;
            scoreFacilityKey = scoreResult.key;
            
            surveyData = surveyData.filter(row => row && row[scoreFacilityKey] && String(row[scoreFacilityKey]).trim() !== '');
            
            surveyData.sort((a, b) => (b['å…¨å›ç­”æ•°'] ?? 0) - (a['å…¨å›ç­”æ•°'] ?? 0));
            
            if (surveyData.length === 0) throw new Error("No valid data rows found in milli_score.csv.");
            
            const personaText = await personaResponse.text();
            const personaResult = parseCSV(personaText);
            personaData = personaResult.data;
            personaFacilityKey = personaResult.key;

            if (adviceResponse && adviceResponse.ok) {
                const adviceText = await adviceResponse.text();
                adviceLines = adviceText.trim().split(/\r?\n/).filter(line => line.trim() !== '');
            }

            surveyData.forEach(data => {
                const option = document.createElement('option');
                option.value = data[scoreFacilityKey];
                option.textContent = data[scoreFacilityKey];
                facilitySelect.appendChild(option);
            });

            loadingMessage.classList.add('hidden');
            mainContent.classList.remove('hidden');
            handleRouteChange();
        } catch (error) {
            console.error("Full error object:", error);
            loadingMessage.innerHTML = `<p class="text-red-500 font-bold">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p><p class="text-sm mt-2">${error.message}</p>`;
        }
    }

    analyzeButton.addEventListener('click', () => { location.hash = encodeURIComponent(facilitySelect.value); });
    backButton.addEventListener('click', () => { location.hash = ''; });
    window.addEventListener('hashchange', handleRouteChange);
    disclaimerButton.addEventListener('click', async () => {
        try {
            const response = await fetch('./credit.txt');
            if (!response.ok) throw new Error('File not found');
            const text = await response.text();
            document.getElementById('disclaimer-text').innerHTML = text.replace(/\n/g, '<br>');
            disclaimerModal.classList.remove('hidden');
        } catch(e) {
            document.getElementById('disclaimer-text').textContent = 'å…è²¬äº‹é …ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            disclaimerModal.classList.remove('hidden');
        }
    });
    closeModalButton.addEventListener('click', () => { disclaimerModal.classList.add('hidden'); });
    disclaimerModal.addEventListener('click', (e) => { if(e.target === disclaimerModal) disclaimerModal.classList.add('hidden'); });

    function getRank(value, dataKey) {
        if (value === null || value === undefined) return { rank: 'N/A', total: surveyData.length };
        const sortedValues = surveyData.map(d => d[dataKey] ?? -Infinity).sort((a, b) => b - a);
        const rank = sortedValues.indexOf(value) + 1;
        return { rank, total: surveyData.length };
    }
    function updateSatisfactionCard(idPrefix, score, dataKey) {
        const scoreValue = score ?? 0;
        document.getElementById(`${idPrefix}`).textContent = scoreValue.toFixed(2);
        document.getElementById(`${idPrefix}-bar`).style.width = `${(scoreValue / 5) * 100}%`;
        const rankInfo = getRank(score, dataKey);
        document.getElementById(`${idPrefix}-rank`).textContent = `(å…¨${rankInfo.total}æ–½è¨­ä¸­ ${rankInfo.rank}ä½)`;
    }
    function getTopN(groups, n) {
        return Object.entries(groups).filter(([key, value]) => value > 0 && key !== 'null' && key !== 'undefined').sort(([, a], [, b]) => b - a).slice(0, n);
    }
    function renderRankingList(elementId, topData) {
        const listElement = document.getElementById(elementId);
        listElement.innerHTML = '';
        if (topData.length === 0) {
            listElement.innerHTML = '<li class="text-gray-500">è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—</li>';
            return;
        }
        topData.forEach(([key, value], index) => {
            const percentage = (value * 100).toFixed(1);
            const li = document.createElement('li');
            li.className = 'flex items-center';
            li.innerHTML = `<span class="rank-badge rank-${index + 1}">${index + 1}</span><span class="ml-3 flex-1">${key}</span><span class="font-bold">${percentage}%</span>`;
            listElement.appendChild(li);
        });
    }

    function displayPersonaAnalysis(scoreData, facilityName) {
        const personaSection = document.getElementById('persona-section');
        const container = document.getElementById('persona-container');
        const template = document.getElementById('persona-template');
        container.innerHTML = '';

        const personaRow = personaData.find(p => p[personaFacilityKey] === facilityName);

        if (!personaRow) {
            personaSection.classList.add('hidden');
            return;
        }

        const personas = [];
        for (let i = 1; i <= 3; i++) {
            if (personaRow[`ps${i}_ã‚«ã‚¦ãƒ³ãƒˆ`]) {
                personas.push({
                    rank: i,
                    companion: personaRow[`ps${i}_åŒä¼´è€…`],
                    age: personaRow[`ps${i}_å¹´ä»£`],
                    region: personaRow[`ps${i}_åœ°æ–¹`],
                    income: personaRow[`ps${i}_å¹´å`],
                    count: personaRow[`ps${i}_ã‚«ã‚¦ãƒ³ãƒˆ`],
                });
            }
        }
        
        if (personas.length === 0) {
            personaSection.classList.add('hidden');
            return;
        }

        const companionIcons = { "å®¶æ—é€£ã‚Œ": "ğŸ‘ª", "2äººçµ„": "ğŸ‘«", "å‹äºº": "ğŸ§‘â€ğŸ¤â€ğŸ§‘", "default": "ğŸ‘¤" };
        const ageIcons = { "è‹¥å¹´å±¤": "ğŸ‘¦", "ä¸­å¹´å±¤": "ğŸ‘¨â€ğŸ’¼", "é«˜é½¢å±¤": "ğŸ‘µ", "default": "ğŸ‘¤" };
        const rankClasses = ["rank-1", "rank-2", "rank-3"];
        const rankTitles = ["ãƒšãƒ«ã‚½ãƒŠï¼‘", "ãƒšãƒ«ã‚½ãƒŠï¼’", "ãƒšãƒ«ã‚½ãƒŠï¼“"];
        const totalAnswers = scoreData['å…¨å›ç­”æ•°'];

        personas.forEach((persona, index) => {
            const clone = template.content.cloneNode(true);
            const card = clone.querySelector('.border');
            
            const rankBadge = card.querySelector('.rank-badge');
            rankBadge.textContent = persona.rank;
            rankBadge.classList.add(rankClasses[index]);
            card.querySelector('h3').textContent = rankTitles[index];
            
            card.querySelector('.persona-companion').textContent = persona.companion;
            card.querySelector('.persona-age').textContent = persona.age;
            card.querySelector('.persona-region').textContent = persona.region;
            card.querySelector('.persona-income').textContent = persona.income;
            
            card.querySelector('.persona-companion-icon').textContent = companionIcons[persona.companion] || companionIcons.default;
            card.querySelector('.persona-age-icon').textContent = ageIcons[persona.age] || ageIcons.default;
            
            // â–¼â–¼â–¼ ç¢ºåº¦ãƒãƒ¼ã®è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä¿®æ­£ â–¼â–¼â–¼
            const certaintyPercent = totalAnswers > 0 ? (persona.count / totalAnswers) * 100 : 0;
            const barWidthPercent = Math.min(100, (certaintyPercent / 25) * 100);
            
            const progressBar = card.querySelector('.progress-bar');
            progressBar.style.width = `${barWidthPercent}%`;
            progressBar.textContent = `${certaintyPercent.toFixed(1)}%`; // ãƒ†ã‚­ã‚¹ãƒˆã¯å®Ÿéš›ã®å‰²åˆã‚’è¡¨ç¤º
            // â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²
            
            card.querySelector('.persona-counts').textContent = `è©²å½“ã‚«ã‚¦ãƒ³ãƒˆ: ${persona.count}ä»¶ / å…¨å›ç­”æ•° ${totalAnswers}ä»¶`;
            
            container.appendChild(clone);
        });

        personaSection.classList.remove('hidden');
    }

    function displayAnalysis(data) {
        const facilityName = data[scoreFacilityKey];
        document.getElementById('facility-title').textContent = `${facilityName} ã®åˆ†æçµæœ`;
        
        document.getElementById('total-answers').textContent = data['å…¨å›ç­”æ•°'] ?? 'N/A';
        const trendEl = document.getElementById('answer-trend');
        const trend = data['ä¼¸ã³ç‡ï¼ˆå¯¾å‰æœˆï¼‰'];
        if (trend === null || trend === undefined) trendEl.innerHTML = `â–¶ï¸ <span class="text-gray-600 font-bold ml-1">å‰æœˆæ¯” N/A</span>`;
        else if (trend > 0) trendEl.innerHTML = `ğŸ”¼ <span class="text-green-600 font-bold ml-1">å‰æœˆæ¯” +${(trend * 100).toFixed(1)}%</span>`;
        else if (trend < 0) trendEl.innerHTML = `ğŸ”½ <span class="text-red-600 font-bold ml-1">å‰æœˆæ¯” ${(trend * 100).toFixed(1)}%</span>`;
        else trendEl.innerHTML = `â–¶ï¸ <span class="text-gray-600 font-bold ml-1">å‰æœˆæ¯” Â±0%</span>`;
        const answersRank = getRank(data['å…¨å›ç­”æ•°'], 'å…¨å›ç­”æ•°');
        document.getElementById('total-answers-rank').textContent = `(å…¨${answersRank.total}æ–½è¨­ä¸­ ${answersRank.rank}ä½)`;
        
        const nps = data.NPS;
        const npsScore = nps !== null && nps !== undefined ? (nps * 100).toFixed(1) : 'N/A';
        document.getElementById('nps-score').textContent = npsScore;
        const normalizedNpsPercent = nps !== null && nps !== undefined ? (nps * 100 + 100) / 2 : 50;
        document.getElementById('nps-bar-value').style.left = `calc(${normalizedNpsPercent}% - 0.375rem)`;
        const npsRank = getRank(data.NPS, 'NPS');
        document.getElementById('nps-rank').textContent = `(å…¨${npsRank.total}æ–½è¨­ä¸­ ${npsRank.rank}ä½)`;
        
        updateSatisfactionCard('product-satisfaction', data['å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æº€è¶³åº¦'], 'å•†å“ãƒ»ã‚µãƒ¼ãƒ“ã‚¹æº€è¶³åº¦');
        updateSatisfactionCard('facility-satisfaction', data['æ–½è¨­å…¨ä½“æº€è¶³åº¦'], 'æ–½è¨­å…¨ä½“æº€è¶³åº¦');
        updateSatisfactionCard('trip-satisfaction', data['æ—…å…¨ä½“æº€è¶³åº¦'], 'æ—…å…¨ä½“æº€è¶³åº¦');
        
        displayPersonaAnalysis(data, facilityName);
        
        const ageGroups = { '10ä»£': data['10ä»£'], '20ä»£': data['20ä»£'], '30ä»£': data['30ä»£'], '40ä»£': data['40ä»£'], '50ä»£': data['50ä»£'], '60ä»£': data['60ä»£'], '70ä»£': data['70ä»£'], '80ä»£': data['80ä»£'], '90ä»£': data['90ä»£'], '100ä»£': data['100ä»£'] };
        const genderGroups = { 'ç”·æ€§': data['ç”·æ€§'], 'å¥³æ€§': data['å¥³æ€§'] };
        const stayDurationGroups = { 'æ—¥å¸°ã‚Š': data['æ—¥å¸°ã‚Š'], '1æ³Š': data['1æ³Š'], '2æ³Š': data['2æ³Š'], '3æ³Š': data['3æ³Š'], '4æ³Šä»¥ä¸Š': data['4æ³Šä»¥ä¸Š'] };
        const companionGroups = { 'ã²ã¨ã‚Šæ—…': data['è‡ªåˆ†ã²ã¨ã‚Š'], 'æ‹äººã¨': data['æ‹äºº'], 'å‹äººã¨': data['å‹äºº'], 'å¤«å©¦2äºº': data['å¤«å©¦2äºº'], 'å›£ä½“æ—…è¡Œ': data['å›£ä½“æ—…è¡Œ'], 'è¦ªæˆšã¨': data['è¦ªæˆš'], 'è¦ªã¨': data['è¦ª'], 'è·å ´ã®åŒåƒšã¨': data['è·å ´ã®åŒåƒš'], 'å®¶æ—(å°å­¦ç”Ÿä»¥ä¸‹)': data['å°å­¦ç”Ÿä»¥ä¸‹é€£ã‚Œã®å®¶æ—'], 'å®¶æ—(ä¸­å­¦ç”Ÿ)': data['ä¸­å­¦ç”Ÿä»¥ä¸‹é€£ã‚Œã®å®¶æ—'], 'å®¶æ—(é«˜æ ¡ç”Ÿ)': data['é«˜æ ¡ç”Ÿé€£ã‚Œã®å®¶æ—'] };
        const purposeGroups = { 'å®¿ã§ã®ã‚“ã³ã‚Š': data['å®¿ã§ã®ã‚“ã³ã‚Šéã”ã™'], 'æ¸©æ³‰': data['æ¸©æ³‰ã‚„éœ²å¤©é¢¨å‘‚'], 'ã‚°ãƒ«ãƒ¡': data['åœ°å…ƒã®ç¾å‘³ã—ã„ã‚‚ã®ã‚’é£Ÿã¹ã‚‹'], 'è‡ªç„¶é‘‘è³': data['èŠ±è¦‹ã‚„ç´…è‘‰ãªã©ã®è‡ªç„¶é‘‘è³'], 'åæ‰€ãƒ»æ—§è·¡è¦³å…‰': data['åæ‰€ã€æ—§è·¡ã®è¦³å…‰'], 'ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯': data['ãƒ†ãƒ¼ãƒãƒ‘ãƒ¼ã‚¯ï¼ˆéŠåœ’åœ°ã€å‹•ç‰©åœ’ã€åšç‰©é¤¨ãªã©ï¼‰'], 'è²·ã„ç‰©': data['è²·ã„ç‰©ã€ã‚¢ã‚¦ãƒˆãƒ¬ãƒƒãƒˆ'], 'ã‚¤ãƒ™ãƒ³ãƒˆ': data['ãŠç¥­ã‚Šã‚„ã‚¤ãƒ™ãƒ³ãƒˆã¸ã®å‚åŠ ãƒ»è¦‹ç‰©'], 'é‘‘è³': data['ã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦ã‚„èŠ¸èƒ½é‘‘è³ï¼ˆã‚³ãƒ³ã‚µãƒ¼ãƒˆç­‰ï¼‰'], 'ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢': data['ã‚¢ã‚¦ãƒˆãƒ‰ã‚¢ï¼ˆæµ·æ°´æµ´ã€é‡£ã‚Šã€ç™»å±±ãªã©ï¼‰'], 'ã¾ã¡ã‚ã‚‹ã': data['ã¾ã¡ã‚ã‚‹ãã€éƒ½å¸‚æ•£ç­–'], 'ä½“é¨“': data['å„ç¨®ä½“é¨“ï¼ˆæ‰‹ä½œã‚Šã€æœç‰©ç‹©ã‚Šãªã©ï¼‰'], 'ã‚¹ãƒãƒ¼ãƒ„': data['ã‚¹ã‚­ãƒ¼ãƒ»ã‚¹ãƒãƒœã€ãƒãƒªãƒ³ã‚¹ãƒãƒ¼ãƒ„'] || data['ãã®ä»–ã‚¹ãƒãƒ¼ãƒ„ï¼ˆã‚´ãƒ«ãƒ•ã€ãƒ†ãƒ‹ã‚¹ãªã©ï¼‰'], 'ãƒ‰ãƒ©ã‚¤ãƒ–': data['ãƒ‰ãƒ©ã‚¤ãƒ–ãƒ»ãƒ„ãƒ¼ãƒªãƒ³ã‚°'], 'çŸ¥äººè¨ªå•': data['å‹äººãƒ»è¦ªæˆšã‚’å°‹ã­ã‚‹'], 'ä»•äº‹é–¢ä¿‚': data['å‡ºå¼µãªã©ä»•äº‹é–¢ä¿‚'] };
        
        const incomeGroups = {
            '100ä¸‡å††æœªæº€': data['100ä¸‡å††æœªæº€'], '100-200ä¸‡å††': data['100ä¸‡å††ä»¥ä¸Š 200ä¸‡å††æœªæº€'], '200-300ä¸‡å††': data['200ä¸‡å††ä»¥ä¸Š 300ä¸‡å††æœªæº€'],
            '300-400ä¸‡å††': data['300ä¸‡å††ä»¥ä¸Š 400ä¸‡å††æœªæº€'], '400-500ä¸‡å††': data['400ä¸‡å††ä»¥ä¸Š 500ä¸‡å††æœªæº€'], '500-600ä¸‡å††': data['500ä¸‡å††ä»¥ä¸Š 600ä¸‡å††æœªæº€'],
            '600-700ä¸‡å††': data['600ä¸‡å††ä»¥ä¸Š 700ä¸‡å††æœªæº€'], '700-800ä¸‡å††': data['700ä¸‡å††ä»¥ä¸Š 800ä¸‡å††æœªæº€'], '800-900ä¸‡å††': data['800ä¸‡å††ä»¥ä¸Š 900ä¸‡å††æœªæº€'],
            '900-1000ä¸‡å††': data['900ä¸‡å††ä»¥ä¸Š 1,000ä¸‡å††æœªæº€'], '1000-1200ä¸‡å††': data['1,000ä¸‡å††ä»¥ä¸Š 1,200ä¸‡å††æœªæº€'], '1200-1500ä¸‡å††': data['1,200ä¸‡å††ä»¥ä¸Š 1,500ä¸‡å††æœªæº€'],
            '1500ä¸‡å††ä»¥ä¸Š': data['1,500ä¸‡å††ä»¥ä¸Š']
        };
        const prefectureGroups = {
            'åŒ—æµ·é“': data['åŒ—æµ·é“'], 'é’æ£®çœŒ': data['é’æ£®çœŒ'], 'å²©æ‰‹çœŒ': data['å²©æ‰‹çœŒ'], 'å®®åŸçœŒ': data['å®®åŸçœŒ'], 'ç§‹ç”°çœŒ': data['ç§‹ç”°çœŒ'], 'å±±å½¢çœŒ': data['å±±å½¢çœŒ'], 'ç¦å³¶çœŒ': data['ç¦å³¶çœŒ'],
            'èŒ¨åŸçœŒ': data['èŒ¨åŸçœŒ'], 'æ ƒæœ¨çœŒ': data['æ ƒæœ¨çœŒ'], 'ç¾¤é¦¬çœŒ': data['ç¾¤é¦¬çœŒ'], 'åŸ¼ç‰çœŒ': data['åŸ¼ç‰çœŒ'], 'åƒè‘‰çœŒ': data['åƒè‘‰çœŒ'], 'æ±äº¬éƒ½': data['æ±äº¬éƒ½'], 'ç¥å¥ˆå·çœŒ': data['ç¥å¥ˆå·çœŒ'],
            'æ–°æ½ŸçœŒ': data['æ–°æ½ŸçœŒ'], 'å¯Œå±±çœŒ': data['å¯Œå±±çœŒ'], 'çŸ³å·çœŒ': data['çŸ³å·çœŒ'], 'ç¦äº•çœŒ': data['ç¦äº•çœŒ'], 'å±±æ¢¨çœŒ': data['å±±æ¢¨çœŒ'], 'é•·é‡çœŒ': data['é•·é‡çœŒ'], 'å²é˜œçœŒ': data['å²é˜œçœŒ'],
            'é™å²¡çœŒ': data['é™å²¡çœŒ'], 'æ„›çŸ¥çœŒ': data['æ„›çŸ¥çœŒ'], 'ä¸‰é‡çœŒ': data['ä¸‰é‡çœŒ'], 'æ»‹è³€çœŒ': data['æ»‹è³€çœŒ'], 'äº¬éƒ½åºœ': data['äº¬éƒ½åºœ'], 'å¤§é˜ªåºœ': data['å¤§é˜ªåºœ'], 'å…µåº«çœŒ': data['å…µåº«çœŒ'],
            'å¥ˆè‰¯çœŒ': data['å¥ˆè‰¯çœŒ'], 'å’Œæ­Œå±±çœŒ': data['å’Œæ­Œå±±çœŒ'], 'é³¥å–çœŒ': data['é³¥å–çœŒ'], 'å³¶æ ¹çœŒ': data['å³¶æ ¹çœŒ'], 'å²¡å±±çœŒ': data['å²¡å±±çœŒ'], 'åºƒå³¶çœŒ': data['åºƒå³¶çœŒ'], 'å±±å£çœŒ': data['å±±å£çœŒ'],
            'å¾³å³¶çœŒ': data['å¾³å³¶çœŒ'], 'é¦™å·çœŒ': data['é¦™å·çœŒ'], 'æ„›åª›çœŒ': data['æ„›åª›çœŒ'], 'é«˜çŸ¥çœŒ': data['é«˜çŸ¥çœŒ'], 'ç¦å²¡çœŒ': data['ç¦å²¡çœŒ'], 'ä½è³€çœŒ': data['ä½è³€çœŒ'], 'é•·å´çœŒ': data['é•·å´çœŒ'],
            'ç†Šæœ¬çœŒ': data['ç†Šæœ¬çœŒ'], 'å¤§åˆ†çœŒ': data['å¤§åˆ†çœŒ'], 'å®®å´çœŒ': data['å®®å´çœŒ'], 'é¹¿å…å³¶çœŒ': data['é¹¿å…å³¶çœŒ'], 'æ²–ç¸„çœŒ': data['æ²–ç¸„çœŒ']
        };
        
        renderRankingList('age-ranking', getTopN(ageGroups, 5));
        renderRankingList('gender-ranking', getTopN(genderGroups, 5));
        renderRankingList('stay-duration-ranking', getTopN(stayDurationGroups, 5));
        renderRankingList('companion-ranking', getTopN(companionGroups, 5));
        renderRankingList('purpose-ranking', getTopN(purposeGroups, 5));
        renderRankingList('income-ranking', getTopN(incomeGroups, 5));
        renderRankingList('prefecture-ranking', getTopN(prefectureGroups, 5));
        
        const adviceContainer = document.getElementById('tifo-advice-text');
        let finalAdvice = 'åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’å…ƒã«ã€ã•ã‚‰ãªã‚‹æ”¹å–„ç‚¹ã‚’æ¢ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼';
        if (adviceLines.length > 0) {
            const randomIndex = Math.floor(Math.random() * adviceLines.length);
            finalAdvice = adviceLines[randomIndex];
        }
        adviceContainer.innerHTML = `<strong>${facilityName}ã•ã‚“ã¸</strong><br><br>${finalAdvice}`;
    }

    loadData();
});
</script>

</body>
</html>
